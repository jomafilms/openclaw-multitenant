The agents have completed their security review. Here's a summary of findings from the Organizations →    
  Groups + Shares refactor:                                                                                 
                                                                                                            
  ---                                                                                                       
  Security Review Results                                                                                   
                                                                                                            
  Good News: No New Vulnerabilities Introduced                                                              
                                                                                                            
  The refactoring itself is architecturally sound:                                                          
  - ✅ Database modules properly split                                                                      
  - ✅ SQL uses parameterized queries (no injection risk)                                                   
  - ✅ Markdown sanitization with DOMPurify is correct                                                      
  - ✅ Session handling in frontend follows safe patterns                                                   
  - ✅ SSE token handling acceptable (EventSource limitation)                                               
                                                                                                            
  ---                                                                                                       
  ⚠️ Pre-Existing Gaps Now Exposed by New Features                                                          
                                                                                                            
  The new invite/sharing functionality surfaces these unimplemented security plans:                         
  ┌──────────┬─────────────────────────────────────────────┬──────┬─────────────────────────────────┐       
  │ Priority │                    Issue                    │ Plan │             Impact              │       
  ├──────────┼─────────────────────────────────────────────┼──────┼─────────────────────────────────┤       
  │ CRITICAL │ Query param tokens in auth middleware       │ 04   │ Tokens leak to logs/history     │       
  ├──────────┼─────────────────────────────────────────────┼──────┼─────────────────────────────────┤       
  │ CRITICAL │ No CSRF protection on invite accept/decline │ 12   │ Attacker can trick users        │       
  ├──────────┼─────────────────────────────────────────────┼──────┼─────────────────────────────────┤       
  │ CRITICAL │ No IP allowlist for admin routes            │ 07   │ Admin compromise risk           │       
  ├──────────┼─────────────────────────────────────────────┼──────┼─────────────────────────────────┤       
  │ HIGH     │ No rate limiting on new invite endpoints    │ 02   │ Spam/brute force                │       
  ├──────────┼─────────────────────────────────────────────┼──────┼─────────────────────────────────┤       
  │ HIGH     │ Admin sessions use 7-day timeout            │ 07   │ Should be 1 hour                │       
  ├──────────┼─────────────────────────────────────────────┼──────┼─────────────────────────────────┤       
  │ MEDIUM   │ activity.ts uses .innerHTML pattern         │ 09   │ Potential XSS if escaping fails │       
  ├──────────┼─────────────────────────────────────────────┼──────┼─────────────────────────────────┤       
  │ MEDIUM   │ Frontend missing CSRF token headers         │ 12   │ API calls unprotected           │       
  └──────────┴─────────────────────────────────────────────┴──────┴─────────────────────────────────┘       
  ---                                                                                                       
  Specific Code Locations                                                                                   
                                                                                                            
  Backend (management-server/middleware/auth.js:27):                                                        
  // VULNERABLE - tokens in query params leak to logs                                                       
  req.headers["x-session-token"] || req.query.token                                                         
                                                                                                            
  Frontend (user-ui/src/pages/activity.ts:476):                                                             
  // RISKY - .innerHTML bypasses Lit's safe templating                                                      
  <div class="activity-description" .innerHTML=${this.formatAction(log)}></div>                             
                                                                                                            
  Frontend (user-ui/src/lib/api.ts):                                                                        
  // MISSING - No CSRF token on state-changing requests                                                     
  // Plan 12 requires: headers['X-CSRF-Token'] = this.csrfToken;                                            
                                                                                                            
  ---                                                                                                       
  Impact on Security Plans                                                                                  
  ┌──────────────────────────┬─────────────┬───────────────────────────────────────────┐                    
  │           Plan           │   Status    │               Action Needed               │                    
  ├──────────────────────────┼─────────────┼───────────────────────────────────────────┤                    
  │ 01 - Headers             │ Not started │ No blockers                               │                    
  ├──────────────────────────┼─────────────┼───────────────────────────────────────────┤                    
  │ 02 - Rate Limiting       │ Not started │ Add to new invite endpoints               │                    
  ├──────────────────────────┼─────────────┼───────────────────────────────────────────┤                    
  │ 03 - MFA                 │ Not started │ No blockers                               │                    
  ├──────────────────────────┼─────────────┼───────────────────────────────────────────┤                    
  │ 04 - Session Security    │ CRITICAL    │ Remove query param tokens                 │                    
  ├──────────────────────────┼─────────────┼───────────────────────────────────────────┤                    
  │ 05 - Alerting            │ Not started │ No blockers                               │                    
  ├──────────────────────────┼─────────────┼───────────────────────────────────────────┤                    
  │ 06 - Dependencies        │ Not started │ No blockers                               │                    
  ├──────────────────────────┼─────────────┼───────────────────────────────────────────┤                    
  │ 07 - Admin Security      │ CRITICAL    │ Add IP allowlist, reduce timeout          │                    
  ├──────────────────────────┼─────────────┼───────────────────────────────────────────┤                    
  │ 08 - WebSocket Proxy     │ Not started │ No blockers                               │                    
  ├──────────────────────────┼─────────────┼───────────────────────────────────────────┤                    
  │ 09 - XSS Mitigation      │ MEDIUM      │ Fix activity.ts innerHTML                 │                    
  ├──────────────────────────┼─────────────┼───────────────────────────────────────────┤                    
  │ 10 - Error Handling      │ Not started │ No blockers                               │                    
  ├──────────────────────────┼─────────────┼───────────────────────────────────────────┤                    
  │ 11 - Encryption Rotation │ Not started │ No blockers                               │                    
  ├──────────────────────────┼─────────────┼───────────────────────────────────────────┤                    
  │ 12 - CSRF Protection     │ CRITICAL    │ Implement before invite feature goes live │                    
  └──────────────────────────┴─────────────┴───────────────────────────────────────────┘                    
  ---                                                                                                       
  Recommendation                                                                                            
                                                                                                            
  Before deploying the Groups + Shares feature to production:                                               
                                                                                                            
  1. Implement Plan 12 (CSRF) - ~6 hours                                                                    
    - Invite accept/decline are high-value CSRF targets                                                     
  2. Implement Plan 04 session changes - ~4 hours                                                           
    - Remove query param tokens from main auth                                                              
    - Create SSE-specific middleware                                                                        
  3. Add rate limiting to invite endpoints - ~2 hours                                                       
    - Prevent spam on accept/decline                                                                        
  4. Fix activity.ts XSS pattern - ~30 minutes                                                              
    - Use unsafeHTML(sanitizeHtml(...)) pattern                                                             
                                                                                                            
  The refactor is clean, but the new social features (invites, sharing) create attack surface that requires 
  Plans 04, 12, and 02 to be implemented first.     
